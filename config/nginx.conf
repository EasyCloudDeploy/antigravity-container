server {
    listen 8080;
    server_name _;

    # ── Shared proxy settings ─────────────────────────────────────────────────
    proxy_http_version 1.1;
    proxy_set_header   Host            $http_host;
    proxy_set_header   X-Real-IP       $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_read_timeout    86400s;
    proxy_send_timeout    86400s;
    proxy_connect_timeout 10s;
    proxy_buffering off;

    # ── WebSocket path (no HTTP auth — VNC password is the auth layer) ────────
    # Browsers cannot send Authorization headers for programmatic WebSocket
    # connections; the VNC session itself is protected by the x11vnc password.
    location /websockify {
        auth_basic off;

        proxy_pass         http://127.0.0.1:6080/websockify;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection "upgrade";
    }

    # ── Everything else: static noVNC files, protected by HTTP Basic Auth ─────
    location / {
        auth_basic "Antigravity IDE — Authentication Required";
        auth_basic_user_file /etc/nginx/.htpasswd;

        proxy_pass         http://127.0.0.1:6080/;
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection "upgrade";
    }
}
