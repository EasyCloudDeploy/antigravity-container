[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
loglevel=info
pidfile=/var/run/supervisord.pid

; ── 1. Virtual framebuffer ───────────────────────────────────────────────────
[program:xvfb]
priority=10
user=developer
command=bash -c 'source /etc/antigravity-env.sh && exec Xvfb :1 -screen 0 ${DISPLAY_WIDTH:-1920}x${DISPLAY_HEIGHT:-1080}x24 -ac'
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/xvfb.log
stderr_logfile=/var/log/supervisor/xvfb.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; ── 2. XFCE desktop + Antigravity autostart ─────────────────────────────────
[program:desktop]
priority=20
user=developer
command=/usr/local/bin/start-desktop.sh
autostart=true
autorestart=true
environment=DISPLAY=":1",HOME="/home/developer"
stdout_logfile=/var/log/supervisor/desktop.log
stderr_logfile=/var/log/supervisor/desktop.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; ── 3. x11vnc (localhost only — nginx/noVNC is the public endpoint) ──────────
[program:x11vnc]
priority=30
user=developer
command=/usr/local/bin/start-x11vnc.sh
autostart=true
autorestart=true
startretries=10
environment=DISPLAY=":1",HOME="/home/developer"
stdout_logfile=/var/log/supervisor/x11vnc.log
stderr_logfile=/var/log/supervisor/x11vnc.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; ── 4. noVNC / websockify (localhost only) ───────────────────────────────────
[program:novnc]
priority=40
user=developer
command=websockify --web=/usr/share/novnc/ 127.0.0.1:6080 127.0.0.1:5900
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/novnc.log
stderr_logfile=/var/log/supervisor/novnc.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB

; ── 5. Nginx (public endpoint, enforces basic auth) ─────────────────────────
[program:nginx]
priority=50
command=nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx.log
stdout_logfile_maxbytes=5MB
stderr_logfile_maxbytes=5MB
